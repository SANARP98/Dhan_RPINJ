<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DhanHQ Two-Account Trading Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    h1 {
      color: #333;
      margin: 20px 0 10px;
    }
    button {
      padding: 10px 15px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
    }
    textarea {
      display: block;
      width: 300px;
      height: 80px;
      margin: 0 auto;
      margin-top: 15px;
      font-size: 14px;
      padding: 8px;
    }
    #message {
      margin-top: 10px;
      color: #007bff;
      font-weight: bold;
    }
    .account-section {
      margin: 20px auto;
      width: 90%;
    }
    .account-section h2 {
      background: #007bff;
      color: #fff;
      padding: 10px;
      text-align: left;
      margin: 0;
    }
    table {
      width: 100%;
      margin: 0;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
    tr:nth-child(even) {
      background: #f9f9f9;
    }
    #orders1, #orders2,
    #holdings1, #holdings2,
    #positions1, #positions2 {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>
  <h1>DhanHQ Two-Account Trading Dashboard</h1>

  <textarea id="textInput" placeholder="Enter your text here..."></textarea>
  <button onclick="submitText()">Submit Text</button>
  <p id="message"></p>

  <button onclick="placeOrder()">Place/Modify Order</button>
  <button onclick="fetchOrders()">Fetch Orders</button>
  <button onclick="fetchHoldings()">Fetch Holdings</button>
  <button onclick="fetchPositions()">Fetch Positions</button>
  <button onclick="cancelAllOrders()">Cancel All Open Orders</button>

  <!-- Orders -->
  <div class="account-section">
    <h2>Account 1 Orders</h2>
    <div id="orders1"></div>
  </div>
  <div class="account-section">
    <h2>Account 2 Orders</h2>
    <div id="orders2"></div>
  </div>

  <!-- Holdings -->
  <div class="account-section">
    <h2>Account 1 Holdings</h2>
    <div id="holdings1"></div>
  </div>
  <div class="account-section">
    <h2>Account 2 Holdings</h2>
    <div id="holdings2"></div>
  </div>

  <!-- Positions -->
  <div class="account-section">
    <h2>Account 1 Positions</h2>
    <div id="positions1"></div>
  </div>
  <div class="account-section">
    <h2>Account 2 Positions</h2>
    <div id="positions2"></div>
  </div>

  <script>
    // 1) SUBMIT TEXT
    async function submitText() {
      let text = document.getElementById("textInput").value;
      if (!text.trim()) {
        alert("Please enter some text.");
        return;
      }
      try {
        let response = await fetch('/submit-text', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text })
        });
        let data = await response.json();

        if (response.ok) {
          document.getElementById("message").textContent = "Text submitted successfully!";
          alert("Submit-Text Response: " + JSON.stringify(data, null, 2));
        } else {
          alert("Error: " + JSON.stringify(data));
        }
      } catch (error) {
        alert("Network error while submitting text: " + error);
      }
    }

    // 2) PLACE/MODIFY ORDER
    async function placeOrder() {
      try {
        let response = await fetch('/place-order', { method: 'POST' });
        let data = await response.json();

        if (response.ok) {
          alert("Response: " + JSON.stringify(data, null, 2));
        } else {
          alert("Error: " + JSON.stringify(data));
        }
      } catch (error) {
        alert("Network error while placing/modifying order: " + error);
      }
    }

    // 3) FETCH ORDERS (for both accounts)
    async function fetchOrders() {
      try {
        let response = await fetch('/orders');
        let data = await response.json();
        // Account 1
        let orders1Div = document.getElementById("orders1");
        if (data.account1 && data.account1.orders) {
          orders1Div.innerHTML = createOrdersTable(data.account1.orders);
        } else if (data.account1 && data.account1.error) {
          orders1Div.innerHTML = `<p style="color:red">${data.account1.error}</p>`;
        } else {
          orders1Div.innerHTML = "<p>No data for Account 1</p>";
        }
        // Account 2
        let orders2Div = document.getElementById("orders2");
        if (data.account2 && data.account2.orders) {
          orders2Div.innerHTML = createOrdersTable(data.account2.orders);
        } else if (data.account2 && data.account2.error) {
          orders2Div.innerHTML = `<p style="color:red">${data.account2.error}</p>`;
        } else {
          orders2Div.innerHTML = "<p>No data for Account 2</p>";
        }
      } catch (error) {
        alert("Error fetching orders: " + error);
      }
    }

    // 4) FETCH HOLDINGS (for both accounts)
    async function fetchHoldings() {
      try {
        let response = await fetch('/holdings');
        let data = await response.json();
        // Account 1
        let holdings1Div = document.getElementById("holdings1");
        if (data.account1 && data.account1.holdings) {
          holdings1Div.innerHTML = createHoldingsTable(data.account1.holdings);
        } else if (data.account1 && data.account1.error) {
          holdings1Div.innerHTML = `<p style="color:red">${data.account1.error}</p>`;
        } else {
          holdings1Div.innerHTML = "<p>No data for Account 1</p>";
        }
        // Account 2
        let holdings2Div = document.getElementById("holdings2");
        if (data.account2 && data.account2.holdings) {
          holdings2Div.innerHTML = createHoldingsTable(data.account2.holdings);
        } else if (data.account2 && data.account2.error) {
          holdings2Div.innerHTML = `<p style="color:red">${data.account2.error}</p>`;
        } else {
          holdings2Div.innerHTML = "<p>No data for Account 2</p>";
        }
      } catch (error) {
        alert("Error fetching holdings: " + error);
      }
    }

    // 5) FETCH POSITIONS (for both accounts)
    async function fetchPositions() {
      try {
        let response = await fetch('/positions');
        let data = await response.json();
        // Account 1
        let positions1Div = document.getElementById("positions1");
        if (data.account1 && data.account1.positions) {
          // pass '1' so we know which account
          positions1Div.innerHTML = createPositionsTable(data.account1.positions, 1);
        } else if (data.account1 && data.account1.error) {
          positions1Div.innerHTML = `<p style="color:red">${data.account1.error}</p>`;
        } else {
          positions1Div.innerHTML = "<p>No data for Account 1</p>";
        }
        // Account 2
        let positions2Div = document.getElementById("positions2");
        if (data.account2 && data.account2.positions) {
          // pass '2' so we know which account
          positions2Div.innerHTML = createPositionsTable(data.account2.positions, 2);
        } else if (data.account2 && data.account2.error) {
          positions2Div.innerHTML = `<p style="color:red">${data.account2.error}</p>`;
        } else {
          positions2Div.innerHTML = "<p>No data for Account 2</p>";
        }
      } catch (error) {
        alert("Error fetching positions: " + error);
      }
    }

    // 6) CANCEL ALL OPEN ORDERS
    async function cancelAllOrders() {
      try {
        let response = await fetch('/cancel-all-orders', { method: 'POST' });
        let data = await response.json();
        alert("Cancel-All Response:\n" + JSON.stringify(data, null, 2));
      } catch (error) {
        alert("Error canceling all orders: " + error);
      }
    }

    // 7) CLOSE-POSITION HELPERS (MKT/LMT)
    async function closeMarketPosition(account, securityId, netQty) {
      if (!confirm("Close this position at MARKET?")) {
        return;
      }
      let payload = {
        account: account,
        securityId: securityId,
        netQty: netQty,
        orderType: "MARKET",
        price: 0
      };

      try {
        let resp = await fetch("/close-position", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        let data = await resp.json();
        if (!resp.ok) {
          alert("Error closing position: " + JSON.stringify(data));
        } else {
          alert("Close Market success: " + JSON.stringify(data, null, 2));
          // Optionally auto-refresh positions
          // fetchPositions();
        }
      } catch (err) {
        alert("Error: " + err);
      }
    }

    async function closeLimitPosition(account, securityId, netQty) {
      let limitPrice = prompt("Enter Limit Price to close position:");
      if (!limitPrice) {
        return; // user canceled
      }
      let priceNum = parseFloat(limitPrice);
      if (isNaN(priceNum) || priceNum <= 0) {
        alert("Invalid price entered.");
        return;
      }

      let payload = {
        account: account,
        securityId: securityId,
        netQty: netQty,
        orderType: "LIMIT",
        price: priceNum
      };

      try {
        let resp = await fetch("/close-position", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        let data = await resp.json();
        if (!resp.ok) {
          alert("Error closing position with limit: " + JSON.stringify(data));
        } else {
          alert("Close Limit success: " + JSON.stringify(data, null, 2));
          // Optionally auto-refresh positions
          // fetchPositions();
        }
      } catch (err) {
        alert("Error: " + err);
      }
    }

    // ------------------ TABLE BUILDERS ------------------
    function createOrdersTable(orders) {
      if (!orders || !Array.isArray(orders) || orders.length === 0) {
        return "<p>No orders found.</p>";
      }
      let tableHTML = `
        <table>
          <tr>
            <th>Order ID</th>
            <th>Status</th>
            <th>Symbol</th>
            <th>Security ID</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Create Time</th>
          </tr>
      `;
      orders.forEach(order => {
        tableHTML += `
          <tr>
            <td>${order.orderId || ""}</td>
            <td>${order.orderStatus || ""}</td>
            <td>${order.tradingSymbol || ""}</td>
            <td>${order.securityId || ""}</td>
            <td>${order.quantity || ""}</td>
            <td>${order.price || ""}</td>
            <td>${order.createTime || ""}</td>
          </tr>
        `;
      });
      tableHTML += "</table>";
      return tableHTML;
    }

    function createHoldingsTable(holdings) {
      if (!holdings || !Array.isArray(holdings) || holdings.length === 0) {
        return "<p>No holdings found.</p>";
      }
      let tableHTML = `
        <table>
          <tr>
            <th>Security ID</th>
            <th>Symbol</th>
            <th>Quantity</th>
            <th>Avg Price</th>
            <th>Current Price</th>
            <th>Profit/Loss</th>
          </tr>
      `;
      holdings.forEach(h => {
        let avg = h.avgCostPrice || 0;
        let last = h.lastTradedPrice || 0;
        let qty = h.totalQty || 0;
        let profitLoss = ((last - avg) * qty).toFixed(2);
        let plColor = profitLoss >= 0 ? 'green' : 'red';

        tableHTML += `
          <tr>
            <td>${h.securityId || ""}</td>
            <td>${h.tradingSymbol || ""}</td>
            <td>${qty}</td>
            <td>${avg.toFixed(2)}</td>
            <td>${last.toFixed(2)}</td>
            <td style="color:${plColor}">${profitLoss}</td>
          </tr>
        `;
      });
      tableHTML += "</table>";
      return tableHTML;
    }

    // Updated to include "Actions" column for closing position
    function createPositionsTable(positions, accountNumber) {
      if (!positions || !Array.isArray(positions) || positions.length === 0) {
        return "<p>No positions found.</p>";
      }

      let tableHTML = `
        <table>
          <tr>
            <th>Trading Symbol</th>
            <th>Product Type</th>
            <th>Net Qty</th>
            <th>Buy Avg</th>
            <th>Sell Avg</th>
            <th>PnL</th>
            <th>Actions</th>
          </tr>
      `;

      positions.forEach((p) => {
        let symbol = p.tradingSymbol || "";
        let productType = p.productType || "";
        let netQty = p.netQty || 0;
        let buyAvg = p.buyAvg || 0;
        let sellAvg = p.sellAvg || 0;

        let realized = p.realizedProfit || 0;
        let unrealized = p.unrealizedProfit || 0;
        let totalPL = realized + unrealized;
        let plColor = totalPL >= 0 ? 'green' : 'red';

        let securityId = p.securityId;

        tableHTML += `
          <tr>
            <td>${symbol}</td>
            <td>${productType}</td>
            <td>${netQty}</td>
            <td>${buyAvg.toFixed(2)}</td>
            <td>${sellAvg.toFixed(2)}</td>
            <td style="color:${plColor}">${totalPL.toFixed(2)}</td>
            <td>
              <button onclick="closeMarketPosition(${accountNumber}, '${securityId}', ${netQty})">
                Close MKT
              </button>
              <button onclick="closeLimitPosition(${accountNumber}, '${securityId}', ${netQty})">
                Close LMT
              </button>
            </td>
          </tr>
        `;
      });

      tableHTML += "</table>";
      return tableHTML;
    }
  </script>
</body>
</html>
