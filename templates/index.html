<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DhanHQ Multi-Account Trading Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to bottom right, #e5e7eb, #f3f4f6);
      min-height: 100vh;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      transition: background-color 0.2s, transform 0.1s;
    }
    .btn:hover {
      transform: scale(1.05);
    }
  </style>
</head>
<body>
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 text-center mb-6">DhanHQ Multi-Account Trading Dashboard</h1>

    <!-- Add Account Section -->
    <div class="card">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Add New Account</h2>
      <div class="flex flex-col sm:flex-row gap-4">
        <input
          id="apiKeyInput"
          type="text"
          class="w-full sm:w-1/2 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Enter Dhan API Key"
        />
        <input
          id="passwordInput"
          type="password"
          class="w-full sm:w-1/2 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="Enter Dhan Password"
        />
        <button
          onclick="addAccount()"
          class="bg-blue-600 text-white px-6 py-2 rounded-lg btn hover:bg-blue-700"
        >
          Add Account
        </button>
      </div>
      <p id="accountMessage" class="mt-2 text-sm font-medium"></p>
    </div>

    <!-- Input Section -->
    <div class="card">
      <textarea
        id="textInput"
        class="w-full h-32 p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
        placeholder="Enter your trading text here (e.g., 'Buy NIFTY 25000 CE at 120, SL 100, Target 150')..."
      ></textarea>
      <button
        onclick="submitText()"
        class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg btn hover:bg-blue-700"
      >
        Submit Text
      </button>
      <p id="message" class="mt-2 text-sm font-medium"></p>
    </div>

    <!-- Structured Data Display -->
    <div id="structuredData" class="card hidden">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Extracted Trading Data</h2>
      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-blue-600 text-white">
            <th class="p-3">Field</th>
            <th class="p-3">Value</th>
          </tr>
        </thead>
        <tbody id="structuredDataTable"></tbody>
      </table>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-wrap justify-center gap-4 mb-8">
      <button
        onclick="placeOrder()"
        class="bg-green-600 text-white px-6 py-2 rounded-lg btn hover:bg-green-700"
      >
        Place/Modify Order
      </button>
      <button
        onclick="fetchOrders()"
        class="bg-indigo-600 text-white px-6 py-2 rounded-lg btn hover:bg-indigo-700"
      >
        Fetch Orders
      </button>
      <button
        onclick="fetchHoldings()"
        class="bg-purple-600 text-white px-6 py-2 rounded-lg btn hover:bg-purple-700"
      >
        Fetch Holdings
      </button>
      <button
        onclick="fetchPositions()"
        class="bg-teal-600 text-white px-6 py-2 rounded-lg btn hover:bg-teal-700"
      >
        Fetch Positions
      </button>
      <button
        onclick="cancelAllOrders()"
        class="bg-red-600 text-white px-6 py-2 rounded-lg btn hover:bg-red-700"
      >
        Cancel All Orders
      </button>
    </div>

    <!-- Accounts Display -->
    <div id="accountsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <script>
    async function addAccount() {
      const apiKey = document.getElementById("apiKeyInput").value.trim();
      const password = document.getElementById("passwordInput").value.trim();
      if (!apiKey || !password) {
        alert("Please enter both API Key and Password.");
        return;
      }

      try {
        const response = await fetch('/add-account', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ api_key: apiKey, password })
        });
        const data = await response.json();
        const messageEl = document.getElementById("accountMessage");

        if (response.ok) {
          messageEl.textContent = data.message;
          messageEl.classList.remove("text-red-600");
          messageEl.classList.add("text-green-600");
          document.getElementById("apiKeyInput").value = "";
          document.getElementById("passwordInput").value = "";
          fetchAccounts(); // Refresh UI
        } else {
          messageEl.textContent = "Error: " + (data.error || "Unknown error");
          messageEl.classList.remove("text-green-600");
          messageEl.classList.add("text-red-600");
        }
      } catch (error) {
        alert("Network error: " + error);
      }
    }

    async function fetchAccounts() {
      // Since accounts are managed server-side, we'll rely on API calls to reflect changes
      fetchOrders(); // Refresh orders to reflect new accounts
      fetchHoldings();
      fetchPositions();
    }

    async function submitText() {
      const text = document.getElementById("textInput").value.trim();
      if (!text) {
        alert("Please enter some text.");
        return;
      }
      try {
        const response = await fetch('/submit-text', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text })
        });
        const data = await response.json();
        const messageEl = document.getElementById("message");

        if (response.ok) {
          messageEl.textContent = "Text submitted successfully!";
          messageEl.classList.remove("text-red-600");
          messageEl.classList.add("text-green-600");
          displayStructuredData(data.structured_data);
        } else {
          messageEl.textContent = "Error: " + (data.error || "Unknown error");
          messageEl.classList.remove("text-green-600");
          messageEl.classList.add("text-red-600");
        }
      } catch (error) {
        alert("Network error: " + error);
      }
    }

    function displayStructuredData(data) {
      const structuredDiv = document.getElementById("structuredData");
      const tableBody = document.getElementById("structuredDataTable");
      structuredDiv.classList.remove("hidden");
      tableBody.innerHTML = "";

      for (const [key, value] of Object.entries(data || {})) {
        tableBody.innerHTML += `
          <tr class="border-b">
            <td class="p-3 text-gray-700">${key}</td>
            <td class="p-3 text-gray-900">${value}</td>
          </tr>
        `;
      }
    }

    async function placeOrder() {
      try {
        const response = await fetch('/place-order', { method: 'POST' });
        const data = await response.json();
        alert(response.ok ? "Order placed/modified: " + JSON.stringify(data) : "Error: " + JSON.stringify(data));
      } catch (error) {
        alert("Network error: " + error);
      }
    }

    async function fetchOrders() {
      try {
        const response = await fetch('/orders');
        const data = await response.json();
        updateAccountsContainer(data, "orders", createOrdersTable);
      } catch (error) {
        alert("Error fetching orders: " + error);
      }
    }

    async function fetchHoldings() {
      try {
        const response = await fetch('/holdings');
        const data = await response.json();
        updateAccountsContainer(data, "holdings", createHoldingsTable);
      } catch (error) {
        alert("Error fetching holdings: " + error);
      }
    }

    async function fetchPositions() {
      try {
        const response = await fetch('/positions');
        const data = await response.json();
        updateAccountsContainer(data, "positions", createPositionsTable);
      } catch (error) {
        alert("Error fetching positions: " + error);
      }
    }

    async function cancelAllOrders() {
      try {
        const response = await fetch('/cancel-all-orders', { method: 'POST' });
        const data = await response.json();
        alert("Cancel All Response: " + JSON.stringify(data));
        fetchOrders(); // Refresh orders
      } catch (error) {
        alert("Error canceling orders: " + error);
      }
    }

    async function closeMarketPosition(accountId, securityId, netQty) {
      if (!confirm("Close this position at MARKET?")) return;
      const payload = { account_id: accountId, securityId, netQty, orderType: "MARKET", price: 0 };
      await closePosition(payload, "Market");
    }

    async function closeLimitPosition(accountId, securityId, netQty) {
      const limitPrice = prompt("Enter Limit Price:");
      if (!limitPrice) return;
      const priceNum = parseFloat(limitPrice);
      if (isNaN(priceNum) || priceNum <= 0) {
        alert("Invalid price.");
        return;
      }
      const payload = { account_id: accountId, securityId, netQty, orderType: "LIMIT", price: priceNum };
      await closePosition(payload, "Limit");
    }

    async function closePosition(payload, type) {
      try {
        const resp = await fetch("/close-position", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        alert(resp.ok ? `Close ${type} success: ` + JSON.stringify(data) : "Error: " + JSON.stringify(data));
        if (resp.ok) fetchPositions();
      } catch (err) {
        alert("Network error: " + err);
      }
    }

    function updateAccountsContainer(data, key, tableFunc) {
      const container = document.getElementById("accountsContainer");
      container.innerHTML = "";
      for (const [accountId, info] of Object.entries(data)) {
        const html = `
          <div class="card">
            <h2 class="text-xl font-semibold text-gray-700 bg-blue-100 p-3 rounded-t-lg">Account ${accountId}</h2>
            <div class="mt-4">
              <h3 class="text-lg font-medium text-gray-600">${key.charAt(0).toUpperCase() + key.slice(1)}</h3>
              <div class="overflow-x-auto">${tableFunc(info[key], accountId)}</div>
            </div>
          </div>
        `;
        container.innerHTML += html;
      }
    }

    function createOrdersTable(orders) {
      if (!orders?.length) return "<p class='text-gray-500'>No orders found.</p>";
      let html = `<table class="w-full border-collapse">
        <thead class="bg-blue-600 text-white">
          <tr><th class="p-2">Order ID</th><th>Status</th><th>Symbol</th><th>Security ID</th><th>Qty</th><th>Price</th><th>Time</th></tr>
        </thead><tbody>`;
      orders.forEach(o => {
        html += `<tr class="border-b"><td class="p-2">${o.orderId || ""}</td><td>${o.orderStatus || ""}</td><td>${o.tradingSymbol || ""}</td><td>${o.securityId || ""}</td><td>${o.quantity || ""}</td><td>${o.price || ""}</td><td>${o.createTime || ""}</td></tr>`;
      });
      return html + "</tbody></table>";
    }

    function createHoldingsTable(holdings) {
      if (!holdings?.length) return "<p class='text-gray-500'>No holdings found.</p>";
      let html = `<table class="w-full border-collapse">
        <thead class="bg-blue-600 text-white">
          <tr><th class="p-2">Security ID</th><th>Symbol</th><th>Qty</th><th>Avg Price</th><th>Current Price</th><th>P/L</th></tr>
        </thead><tbody>`;
      holdings.forEach(h => {
        const avg = h.avgCostPrice || 0;
        const last = h.lastTradedPrice || 0;
        const qty = h.totalQty || 0;
        const pl = ((last - avg) * qty).toFixed(2);
        html += `<tr class="border-b"><td class="p-2">${h.securityId || ""}</td><td>${h.tradingSymbol || ""}</td><td>${qty}</td><td>${avg.toFixed(2)}</td><td>${last.toFixed(2)}</td><td class="${pl >= 0 ? 'text-green-600' : 'text-red-600'}">${pl}</td></tr>`;
      });
      return html + "</tbody></table>";
    }

    function createPositionsTable(positions, accountId) {
      if (!positions?.length) return "<p class='text-gray-500'>No positions found.</p>";
      let html = `<table class="w-full border-collapse">
        <thead class="bg-blue-600 text-white">
          <tr><th class="p-2">Symbol</th><th>Type</th><th>Net Qty</th><th>Buy Avg</th><th>Sell Avg</th><th>PnL</th><th>Actions</th></tr>
        </thead><tbody>`;
      positions.forEach(p => {
        const totalPL = ((p.realizedProfit || 0) + (p.unrealizedProfit || 0)).toFixed(2);
        html += `<tr class="border-b">
          <td class="p-2">${p.tradingSymbol || ""}</td><td>${p.productType || ""}</td><td>${p.netQty || 0}</td><td>${(p.buyAvg || 0).toFixed(2)}</td><td>${(p.sellAvg || 0).toFixed(2)}</td><td class="${totalPL >= 0 ? 'text-green-600' : 'text-red-600'}">${totalPL}</td>
          <td><button class="bg-blue-500 text-white px-2 py-1 rounded mr-1 hover:bg-blue-600" onclick="closeMarketPosition('${accountId}', '${p.securityId}', ${p.netQty})">MKT</button><button class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600" onclick="closeLimitPosition('${accountId}', '${p.securityId}', ${p.netQty})">LMT</button></td>
        </tr>`;
      });
      return html + "</tbody></table>";
    }

    // Initial fetch to load existing accounts from .env (if needed)
    window.onload = () => {
      fetchAccounts(); // Load initial state
    };
  </script>
</body>
</html>